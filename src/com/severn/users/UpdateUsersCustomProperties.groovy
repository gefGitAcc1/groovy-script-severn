import java.sql.ResultSet
import java.sql.SQLException
import java.util.Map.Entry;
import java.util.logging.*

import org.joda.time.DateTime
import org.joda.time.DateTimeZone
import org.joda.time.format.DateTimeFormat
import org.joda.time.format.DateTimeFormatter
import org.springframework.context.*
import org.springframework.dao.DataAccessException
import org.springframework.jdbc.core.*

import javax.mail.*;
import javax.mail.internet.*
import javax.sql.*

import com.google.appengine.api.datastore.*
import com.google.appengine.api.datastore.Query.Filter;
import com.google.appengine.api.datastore.Query.FilterPredicate;
import com.google.appengine.api.datastore.Query.FilterOperator
import com.google.appengine.api.memcache.*
import com.google.apphosting.api.ApiProxy

import com.severn.common.domain.User
import com.severn.script.utils.DatastoreSciptUtils
import com.severn.common.utils.DatastoreUtil

ApplicationContext ctx = binding.variables.get('applicationContext')
DateTime dt = DateTime.now(DateTimeZone.UTC)
DateTimeFormatter f = DateTimeFormat.forPattern('yyyy-MM-dd').withZoneUTC()
def infos = []

Logger logger = Logger.getLogger('com.severn')

def count = 0

long[] users = [5025046434152448,6384539038384128,6521858672295936,4971800873140224,5880062711693312,4915351304273920,5866455437410304,6084800497582080,5623005735550976,4929953209516032,5429598348115968,5565471477727232,6628283264270336,6692864003145728,6661738515660800,6408471518904320,4961971932758016,6060744410923008,5497779257344000,5674278637797376,5142486992289792,6022756217913344,6295606965305344,6148751075835904,5389295174025216,6458870082830336,6520341470904320,6093694963810304,6192801615183872,5023197865967616,6483238175375360,4780378052100096,5888615002406912,4814340568907776,5756020251951104,5979083723767808,6070415320416256,5336745024421888,4657854834278400,6678656016449536,6085288028798976,4609827346055168,6439631561162752,6009706677010432,4915039659098112,5529420763758592,5987763299024896,5810060184780800,4861785562677248,5190312071790592,6604771287891968,5575264695222272,5471033892012032,5854151480180736,5757492326825984,6192591413444608,4781949397762048,5902671994159104,5289593816481792,6501445128945664,5109419524227072,4857566935908352,6268463021555712,6075585750106112,5326414961180672,6176647169441792,4648053779726336,5082868047937536,5597230126858240,5827017772630016,6148415158222848,5745139388514304,6096274758565888,6474066390155264,5679712931151872,5382082233630720,5436162461138944,5336378850148352,6648764973449216,4775463615463424,6471924946305024,6011401893052416,4620296991539200,5097151888621568,5602056126595072,4957644870647808,6387570530320384,5124067454615552,5815321020596224,5166392331468800,6249293504577536,6025858400649216,6359838815682560,4734896625942528,5625004975718400,5766432528793600,6297165168115712,6066972952363008,6293060613832704,4801256391442432,5363405186662400,5727253411397632,5808936090337280,5945316883824640,6075053463568384,5379496944336896,5187076638113792,5999135084773376,6533975974608896,5778651676147712,5022594429353984,6380125059809280,4949709852508160,6324450287943680,5146743640424448,5979786923999232,4782710366142464,6514374347849728,5824541174530048,5902581212643328,4713153572110336,6016066317713408,5392945072046080,6721193003450368,6507292380889088,5523997864230912,6049091795550208,5263723389255680,5643138059206656,4503638289416192,6065182819221504,6657438190141440,6110612034682880,6406591921258496,5171969593966592,6564501104099328,4723982946271232,5765474179612672,5130276920360960,5375249859215360,5437755290025984,6256152919670784,5537916782641152,5142920268087296,4952349012393984,5272062728863744,5993445142298624,4818696408137728,4857996914982912,6671367146569728,5022636533874688,6122233209552896,5414486130294784,5186792062976000,5846028380012544,5181063761494016,5055102829199360,6070829531004928,5450611939082240,5187651492642816,6405218873901056,6051711008374784,5358823643545600,6260342087745536,6269293204340736,4776790143795200,5726905629147136,4848198270058496,6608662796697600,4818230269968384,6564761754927104,5580918910615552,5742163232030720,5494208742817792,4828346020003840,5095265471037440,6562254500659200,6533714191319040,6002742614032384,5981893018255360,5563917706199040,5372500190953472,6468725682208768,5850916602249216,5697914204585984,5132749357711360,4670192184459264,4625129391783936,4851057891999744,5375635181535232,6230030129561600,5669297161502720,5126601091055616,5583997928210432,5837311769051136,5851579210006528,5666916105453568,5144184867520512,5441901137231872,5903732494565376,5033662574755840,6557425363582976,6027605596700672,4644384569032704,6664083081265152,5355628254986240,4787959072030720,6411225117229056,6135699425198080,5638867787972608,4946833582325760,5607664582131712,5086875118206976,5887193238208512,5236414345117696,6037217410547712,4671688363999232,4604949978677248,5542792613855232,5877062200983552,4833496206934016,5123438027997184,5679558641582080,4770125474430976,4759040331612160,5551865780502528,5918035283017728,4968429321715712,6699578416955392,6245335423778816,4896690006917120,5316535106142208,5970785500921856,5708999285538816,4816205729759232,5139030546055168,4751942696828928,5706092479774720,4833595467235328,5706670226276352,5050681328140288,4828279017046016,5268984134893568,6144304203431936,6255377879400448,5563339742642176,6595800397250560,6370910117298176,5397167251390464,4824194528313344,4934774287237120,5693938790825984,5381908916600832,5381561095553024,5902271035473920,6354406772572160,6110488550178816,6748156329984000,6711994404044800,5033285469077504,6734584208162816,6220891070398464,5650962751422464,5217935726477312,5767598129020928,6376710973947904,4875704142397440,6711324292677632,5201968380248064,4969738751967232,6263725701988352,6320773957419008,6645880273764352,6513935816589312,5910435218849792,5274674832343040,6680532363509760,6176798281826304,6028505681756160,4639074328510464,5936249578717184,6460206530691072,6748511635767296,6181494258139136,5906534864257024,5706933087502336,5118134750019584,6131792242278400,6468909145260032,5148789001158656,5675315585089536,6743770878967808,6389605019418624,6739853545832448,5151544642109440,5566469541724160,5401431593975808,5597627449081856,5219938435334144,5115243633049600,6469808987045888,5494792396996608,5834060646580224,5078961762598912,6626703930556416,4699046001246208,6234227279396864,4709653538668544,5679167147343872,5296308192542720,4669832038449152,6172665583763456,6625699170353152,5126333437837312,5356162140602368,5703718705037312,5649272753094656,6603145855631360,4668684135038976,5353756165144576,4776218170753024,6570797178028032,5744779223629824,5360536643436544,5355679442272256,6689753813483520,4526388664074240,5635250972524544,4851062157606912,4586151034748928,4562223061008384,6329103530590208,5441186346041344,4976910701428736,5812452011802624,6393816117411840,6201801312305152,5346779745746944,6079952842653696,4994791522697216,4596767011110912,4727078443286528,5793123149021184,6496669980950528,4514877757456384,4845111845322752,5739851193253888,6488460687835136,6419697574608896,4987947311955968,5626041631506432,6245238812180480,5002882586771456,5798671592456192,5441568600227840,6733415733788672,6446056857403392,5760402843500544,4973246599397376,5847958565158912,4697126440271872,6045085220208640,5689927437123584,6245945225248768,5638205774757888,6427821218988032,4991809091534848,6640162472722432,5360253953638400,4717092828872704,6747877337464832,6290197388984320,4630295381803008,5132819310313472,4525148431450112,5462662140919808,4809222926630912,6001458741772288,5095880754462720,6511820712968192,5503134043471872,6638746783973376,5405144478908416,4704917590638592,5260782236336128,5998826392387584,5458086474022912,5244580394958848,6382934725492736,6306603895619584,4849915044823040,5641881983647744,5675833648742400,6042831020883968,5708377354141696,6333214363746304,5885574337527808,6703246270791680,4507752012447744,5764620408061952,6401601504804864,4636076575555584,4843033974538240,6700365918502912,5656511345852416,6412447182225408,6180062815584256,5714656650854400,6412841165783040,6694671127412736,5244787627130880,5087683108929536,5924452427628544,5763943548059648,6351714078687232,5439857257086976,4634473718087680,4533851199111168,4615391471992832,5176550948339712,6725733647908864,5964332488720384,6667813287624704,6366524232171520,5108448002834432,5204143160426496,5149168952672256,5124620079333376,5352870515834880,5354255458238464,5838742194487296,5508173074006016,4539496203812864,4829325038714880,4661830390644736,5951735739711488,6410444506923008,5005045375434752,5485371931492352,5291175438188544,4605485346979840,6240986974912512,6349422173618176,5485876947714048,6406367777652736,5649488923328512,6367608541544448,5415127137386496,5534009198116864,4673220778131456,6616915979010048,6273096985083904,5082531077554176,5508346835632128,6452236128354304,5191144660008960,4732674655649792,5581048619466752,4900682393976832,5006472017608704,5376665407455232,5611735321935872,5807006714691584,6154008585568256,4763736865767424,5065293092093952,6508675360358400,6635893610774528,5025581493125120,6681019036991488,6145749057273856,6263411951271936,6309027473522688,6418975184388096,5189107541082112,4866386831605760,5964526607400960,6251278744158208,6372236154896384,5796948001947648,4672558497529856,5339707092238336,5305522361204736,5782939408269312,5133387588173824,5071594545217536,5292222672011264,6379864494964736,5869695956680704,6212969439428608,5414690426454016,5892194780053504,4905919270879232,4592220601581568,5634893785595904,4991442639388672,5755273097510912,5126278603603968,5589382097534976,5042074167541760,6604716912934912,4533135202058240,4813712111173632,6110510243119104,4727020465422336,5335546359447552,6223039316361216,6186445212483584,6407119524855808,6490990020919296,5716325660884992,5079835230601216,6216423234863104,4887063093575680,5866488773738496,5367694558756864,4918803468124160,6055653297618944,5106382406680576,6217754441940992,6636970001301504,5701011954991104,5663095316807680,5839784764243968,6179740942598144,5125988580065280,5017741361676288,5661715708510208,6508182556901376] as long[]

// long[] users = [4566076553691136] as long[]

DatastoreService datastore = DatastoreServiceFactory.getDatastoreService()
MemcacheService memcacheService = MemcacheServiceFactory.getMemcacheService('default')

users.each { userId ->
    Key parent = KeyFactory.createKey('User', userId)
    Key key = KeyFactory.createKey(parent, 'UserCustomProps', 'Default')

    Entity entity = null
    
    try {
        entity = datastore.get(key)
        def prop = entity.getProperty('UserChallengeStateV2')
        boolean result = false // prop
        if (prop) {
            count++
        }
    
        if (result) {
            entity.removeProperty('UserChallengeStateV2')
            datastore.put(entity)
            memcacheService.delete("User_UserCustomProps_Default_${userId}".toString())
        }
    } catch (EntityNotFoundException e) {
        
    }
}

def result = 'Ok counts ' + count
notifyEnded('sergey.shcherbovich@synesis.ru', result)
result

void notifyEnded(def reciever, def message) {
    try {
        MimeMessage msg = new MimeMessage(Session.getDefaultInstance(new Properties(), null));
        msg.setFrom(new InternetAddress("${ApiProxy.getCurrentEnvironment().getAppId().replace('s~', '')}@appspot.gserviceaccount.com", "Script executor module"));
        msg.addRecipient(Message.RecipientType.TO,
         new InternetAddress(reciever, "Dear DEV"));
        msg.setSubject("Script was executed successfully at ${new Date()}");
        msg.setText(message);
        Transport.send(msg);
    
    } catch (AddressException e) {
        Logger.getLogger('com.severn').log(Level.WARNING, "Got", e)
    } catch (MessagingException e) {
        Logger.getLogger('com.severn').log(Level.WARNING, "Got", e)
    }
}